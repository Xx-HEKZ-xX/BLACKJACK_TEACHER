<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H3KZs BlackJack Teacher tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            width: 100px;
            height: 140px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background-color: white; /* Always white */
            border: 2px solid #e5e7eb; /* Light border */
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .card-red { color: #D92D20; }
        .card-black { color: #101828; }
        .strategy-table td, .strategy-table th {
            border: 1px solid #e5e7eb;
            text-align: center;
            padding: 8px;
            min-width: 40px;
        }
        .dark .strategy-table { color: #1f2937; }
        .correct { background-color: #D1FADF; border: 1px solid #039855; color: #065F46; }
        .dark .correct { background-color: #065F46; border-color: #10B981; color: #A7F3D0; }
        .incorrect { background-color: #FEE4E2; border: 1px solid #D92D20; color: #991B1B; }
        .dark .incorrect { background-color: #991B1B; border-color: #F87171; color: #FEE2E2; }
        .action-btn { 
            transition: all 0.2s ease-in-out; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn:active { transform: translateY(0); }
        .action-btn.key-pressed {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        .card.hidden-initial { opacity: 0; transform: scale(0); }
        @keyframes deal-in {
            from { opacity: 0; transform: translateY(-80px) rotateX(-90deg); }
            to { opacity: 1; transform: translateY(0) rotateX(0deg); }
        }
        .deal-animation { animation: deal-in 0.4s ease-out; }
        
        /* Cell colors for strategy chart */
        .cell-Hit { background-color: #DBEAFE; } /* blue-100 */
        .cell-Stand { background-color: #FEE2E2; } /* red-100 */
        .cell-Double { background-color: #D1FAE5; } /* green-100 */
        .cell-Split { background-color: #FEF3C7; } /* yellow-100 */
        .cell-Surrender { background-color: #E5E7EB; } /* gray-200 */

        .key-hint {
            font-size: 0.75rem;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.2);
            color: white;
            line-height: 1;
        }
        .dark #in-game-guide h3,
        .dark #in-game-guide .strategy-table th,
        .dark #in-game-guide .strategy-table td:first-child {
            color: #f3f4f6; /* gray-100 */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-white">H3KZs BlackJack Teacher tool</h1>
            <p class="text-lg text-gray-400 mt-2">Master the optimal move for any hand.</p>
        </header>

        <div id="setup-section" class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-center text-white">Game Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="dealer-rule-select" class="block text-sm font-medium text-gray-300">Dealer Rule</label>
                    <select id="dealer-rule-select" class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="s17">Stands on Soft 17</option>
                        <option value="h17">Hits on Soft 17</option>
                    </select>
                </div>
                <div>
                    <label for="das-select" class="block text-sm font-medium text-gray-300">Double After Split</label>
                    <select id="das-select" class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="yes">Allowed</option>
                        <option value="no">Not Allowed</option>
                    </select>
                </div>
                <div>
                    <label for="decks-select" class="block text-sm font-medium text-gray-300">Number of Decks</label>
                    <select id="decks-select" class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="6" selected>6+</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-700">
                <label class="block text-sm font-medium text-center text-gray-300">Hand Types to Train</label>
                <div id="hand-type-selection" class="flex justify-center flex-wrap gap-x-6 gap-y-2 mt-2 text-sm">
                    <div><input type="checkbox" id="train-all" class="form-checkbox" checked> <label for="train-all">All</label></div>
                    <div><input type="checkbox" id="train-hard" class="form-checkbox hand-type"> <label for="train-hard">Hard Totals</label></div>
                    <div><input type="checkbox" id="train-soft" class="form-checkbox hand-type"> <label for="train-soft">Soft Totals</label></div>
                    <div><input type="checkbox" id="train-pairs" class="form-checkbox hand-type"> <label for="train-pairs">Pairs</label></div>
                    <div><input type="checkbox" id="train-surrender" class="form-checkbox hand-type"> <label for="train-surrender">Surrender</label></div>
                    <div><input type="checkbox" id="train-challenge" class="form-checkbox hand-type"> <label for="train-challenge">Challenge Me</label></div>
                </div>
                <p id="hand-type-error" class="text-center text-red-500 text-xs mt-2 hidden">Please select at least one hand type to train.</p>
            </div>


             <div class="text-center mt-6 pt-6 border-t border-gray-700">
                <label for="hand-count-input" class="block text-sm font-medium text-gray-300">Hands to Practice</label>
                <input type="number" id="hand-count-input" class="w-40 text-center p-2 mt-1 border-2 border-gray-600 rounded-lg bg-gray-700 text-white" value="20" min="1" max="100">
                <button id="start-quiz-btn" class="ml-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md align-bottom">Start</button>
            </div>
            
            <div id="persistent-stats" class="mt-8 pt-4 border-t border-gray-700 text-center">
                 <h3 class="text-lg font-medium text-white">Lifetime Stats</h3>
                 <p id="lifetime-stats-display" class="text-sm text-gray-400 mt-1">Loading stats...</p>
                 <button id="reset-stats-btn" class="text-xs text-red-500 hover:underline mt-2">Reset Stats</button>
            </div>

        </div>

        <main id="main-content" class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8 hidden"></main>
        
        <div id="report-section" class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8 hidden"></div>

        <div id="strategy-chart-section" class="bg-white p-6 rounded-2xl shadow-lg">
             <h2 id="strategy-chart-title" class="text-3xl font-bold text-center mb-6 text-gray-900"></h2>
             <div id="strategy-chart-container" class="overflow-x-auto"></div>
        </div>
        <footer class="text-center text-gray-400 mt-8 text-sm">
            <p>This tool is for educational purposes. Always gamble responsibly.</p>
            <a href="https://github.com/Xx-HEKZ-xX/BLACKJACK_TEACHER" target="_blank" class="text-indigo-500 hover:underline">GitHub Repository</a>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const setupSection = document.getElementById('setup-section');
        const mainContent = document.getElementById('main-content');
        const reportSection = document.getElementById('report-section');
        const handCountInput = document.getElementById('hand-count-input');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const lifetimeStatsDisplay = document.getElementById('lifetime-stats-display');
        const resetStatsBtn = document.getElementById('reset-stats-btn');
        const dealerRuleSelect = document.getElementById('dealer-rule-select');
        const dasSelect = document.getElementById('das-select');
        const decksSelect = document.getElementById('decks-select');
        const strategyChartTitle = document.getElementById('strategy-chart-title');
        const strategyChartContainer = document.getElementById('strategy-chart-container');
        const handTypeCheckboxes = document.querySelectorAll('.hand-type');
        const trainAllCheckbox = document.getElementById('train-all');
        const handTypeError = document.getElementById('hand-type-error');

        // --- Game State ---
        let playerHand = [], dealerCard, correctAnswer;
        let totalHands = 20, currentHand = 0;
        let totalAttempts = 0, correctFirstTry = 0;
        let wrongGuesses = [];
        let isFirstGuess = true;
        let handStartTime = 0;
        let decisionTimes = [];
        let gameSettings = {};
        let lifetimeStats = { totalHandsPlayed: 0, totalCorrectFirstTries: 0 };
        let mistakes = [];

        // --- Card Data ---
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const suits = ['♥', '♦', '♣', '♠'];
        const suitColors = { '♥': 'card-red', '♦': 'card-red', '♣': 'card-black', '♠': 'card-black' };

        // --- Helper Functions ---
        const getCardValue = c => 'JQK'.includes(c.rank) ? 10 : c.rank === 'A' ? 11 : parseInt(c.rank);
        const getHandTotal = h => { let t = h.reduce((a, c) => a + getCardValue(c), 0), aces = h.filter(c => c.rank === 'A').length; while (t > 21 && aces-- > 0) t -= 10; return t; };
        const isSoft = h => h.some(c => c.rank === 'A') && getHandTotal(h) !== h.reduce((a, c) => a + getCardValue(c), 0);
        const isPair = h => h.length === 2 && h[0].rank === h[1].rank;
        const isSurrender = (pHand, dCard) => {
            const pTotal = getHandTotal(pHand);
            const dVal = getCardValue(dCard);
            if (isSoft(pHand) || isPair(pHand)) return false;
            if (pTotal === 16 && [9, 10, 11].includes(dVal)) return true;
            if (pTotal === 15 && dVal === 10) return true;
            return false;
        };
        const getRandomCard = (excludeRank = []) => {
            let rank;
            do {
                rank = ranks[Math.floor(Math.random() * ranks.length)];
            } while (excludeRank.includes(rank));
            return { rank, suit: suits[Math.floor(Math.random() * suits.length)] };
        };
        
        function renderCard(element, card) {
            element.innerHTML = `<span>${card.rank}</span><span>${card.suit}</span>`;
            element.className = `card ${suitColors[card.suit]}`;
        }

        function getCorrectAction(pHand, dCard, settings) {
            const p1 = pHand[0], p2 = pHand[1];
            const dVal = getCardValue(dCard);
            const pTotal = getHandTotal(pHand);

            if (isPair(pHand)) {
                const val = getCardValue(p1);
                if (val === 11 || val === 8) return 'Split';
                if (val === 10) return 'Stand';
                if (val === 9) return !([7, 10, 11].includes(dVal)) ? 'Split' : 'Stand';
                if (val === 7) return dVal <= 7 ? 'Split' : 'Hit';
                if (val === 6) return (settings.dealerRule === 'h17' && dVal === 2) ? 'Split' : (dVal <= 6 ? 'Split' : 'Hit');
                if (val === 5) return dVal <= 9 ? 'Double' : 'Hit';
                if (val === 4) return (dVal === 5 || dVal === 6) && settings.das ? 'Split' : 'Hit';
                if (val === 2 || val === 3) return dVal <= 7 ? 'Split' : 'Hit';
            }

            if (isSoft(pHand)) {
                if (pTotal >= 20) return 'Stand';
                if (pTotal === 19) return (dVal === 6 && settings.decks <= 2) ? 'Double' : 'Stand';
                if (pTotal === 18) {
                    if (dVal >= 2 && dVal <= 6) return 'Double';
                    if (dVal >= 7 && dVal <= 8) return 'Stand';
                    return 'Hit';
                }
                if (pTotal === 17) return (dVal >= 3 && dVal <= 6) ? 'Double' : 'Hit';
                if (pTotal === 15 || pTotal === 16) return (dVal >= 4 && dVal <= 6) ? 'Double' : 'Hit';
                if (pTotal === 13 || pTotal === 14) return (dVal >= 5 && dVal <= 6) ? 'Double' : 'Hit';
            }

            if (isSurrender(pHand, dCard)) return 'Surrender';
            if (pTotal >= 17) return 'Stand';
            if (pTotal === 16) return (dVal >= 2 && dVal <= 6) ? 'Stand' : 'Hit';
            if (pTotal === 15) return (dVal >= 2 && dVal <= 6) ? 'Stand' : 'Hit';
            if (pTotal >= 13 && pTotal <= 14) return (dVal >= 2 && dVal <= 6) ? 'Stand' : 'Hit';
            if (pTotal === 12) return (dVal >= 4 && dVal <= 6) ? 'Stand' : 'Hit';
            if (pTotal === 11) return 'Double';
            if (pTotal === 10) return dVal <= 9 ? 'Double' : 'Hit';
            if (pTotal === 9) return (dVal >= 3 && dVal <= 6) ? 'Double' : 'Hit';
            
            return 'Hit';
        }

        function getStrategyExplanation(pHand, dCard, settings, action) {
            const pTotal = getHandTotal(pHand);
            const dVal = getCardValue(dCard);
            if (action === "Stand" && pTotal >= 17 && !isSoft(pHand)) return "Always stand on a hard 17 or higher.";
            if (action === "Stand" && pTotal <= 16 && dVal <= 6) return "Stand because the dealer has a high chance of busting with a low card.";
            if (action === "Hit" && pTotal <= 11) return "Always hit on 11 or less to improve your hand without risk of busting.";
            if (action === "Double" && pTotal === 11) return "This is the best hand to double down on for maximum profit.";
            if (action === "Split" && isPair(pHand) && pHand[0].rank === 'A') return "Always split Aces to get two strong starting hands.";
            if (action === "Surrender") return "Surrender gives you the best odds to save half your bet in a very unfavorable situation.";
            return "This is the mathematically optimal move for this scenario.";
        }
        
        function generateSpecificHand() {
            const { trainOn } = gameSettings;
            let hand, dealerCard;

            if (trainOn.challenge && mistakes.length > 0) {
                const mistake = mistakes[Math.floor(Math.random() * mistakes.length)];
                return { hand: mistake.playerHand, dealerCard: mistake.dealerCard };
            }
            
            let handType = 'all';
            if (!trainOn.all) {
                const types = [];
                if (trainOn.hard) types.push('hard');
                if (trainOn.soft) types.push('soft');
                if (trainOn.pairs) types.push('pairs');
                if (trainOn.surrender) types.push('surrender');
                handType = types[Math.floor(Math.random() * types.length)];
            }

            switch (handType) {
                case 'soft':
                    hand = [{ rank: 'A', suit: suits[Math.floor(Math.random()*4)] }, getRandomCard(['A', '10', 'J', 'Q', 'K'])];
                    break;
                case 'pairs':
                    const rank = ranks[Math.floor(Math.random() * ranks.length)];
                    hand = [{ rank, suit: suits[0] }, { rank, suit: suits[1] }];
                    break;
                case 'surrender':
                    const surrenderHands = [
                        [[{rank:'10'}, {rank:'6'}], {rank:'9'}],
                        [[{rank:'10'}, {rank:'6'}], {rank:'10'}],
                        [[{rank:'9'}, {rank:'7'}], {rank:'A'}],
                        [[{rank:'10'}, {rank:'5'}], {rank:'10'}],
                    ];
                    const selected = surrenderHands[Math.floor(Math.random() * surrenderHands.length)];
                    hand = selected[0].map(c => ({...c, suit: suits[Math.floor(Math.random()*4)]}));
                    dealerCard = { ...selected[1], suit: suits[Math.floor(Math.random()*4)] };
                    return { hand, dealerCard };
                case 'hard':
                    do {
                        hand = [getRandomCard(['A']), getRandomCard(['A'])];
                    } while (isPair(hand) || isSoft(hand));
                    break;
                default: // all
                    do {
                        hand = [getRandomCard(), getRandomCard()];
                    } while (getHandTotal(hand) === 21);
            }
            
            dealerCard = getRandomCard();
            return { hand, dealerCard };
        }

        function newHand() {
            if (currentHand >= totalHands) {
                updateLifetimeStats();
                if (totalHands >= 20) showAccuracyReport();
                else endQuiz();
                return;
            }
            
            const { hand, dealerCard: generatedDealerCard } = generateSpecificHand();
            playerHand = hand;
            dealerCard = generatedDealerCard;
            correctAnswer = getCorrectAction(playerHand, dealerCard, gameSettings);

            currentHand++;
            isFirstGuess = true;
            document.getElementById('hand-counter').textContent = `Hand: ${currentHand} of ${totalHands}`;
            
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.textContent = '';
            feedbackEl.className = 'text-center text-lg font-semibold p-4 rounded-lg h-16 mb-4';
            
            const playerTotalEl = document.getElementById('player-total');
            const dealerTotalEl = document.getElementById('dealer-total');
            playerTotalEl.textContent = '';
            dealerTotalEl.textContent = '';
            
            const actionButtons = [...mainContent.querySelectorAll('.action-btn')];
            actionButtons.forEach(b => b.disabled = true);

            const dealerCardEl = document.getElementById('dealer-card');
            const playerCard1El = document.getElementById('player-card-1');
            const playerCard2El = document.getElementById('player-card-2');
            const allCardEls = [dealerCardEl, playerCard1El, playerCard2El];
            
            allCardEls.forEach(cardEl => {
                cardEl.classList.add('hidden-initial');
                cardEl.classList.remove('deal-animation');
                cardEl.innerHTML = '';
            });

            setTimeout(() => { renderCard(dealerCardEl, dealerCard); dealerCardEl.classList.remove('hidden-initial'); dealerCardEl.classList.add('deal-animation'); }, 0);
            setTimeout(() => { renderCard(playerCard1El, playerHand[0]); playerCard1El.classList.remove('hidden-initial'); playerCard1El.classList.add('deal-animation'); }, 150);
            setTimeout(() => { renderCard(playerCard2El, playerHand[1]); playerCard2El.classList.remove('hidden-initial'); playerCard2El.classList.add('deal-animation'); }, 300);

            setTimeout(() => {
                let playerTotalText = `Total: ${getHandTotal(playerHand)}`;
                if (isSoft(playerHand)) playerTotalText += ` (Soft)`;
                playerTotalEl.textContent = playerTotalText;
                
                const dealerValue = getCardValue(dealerCard);
                dealerTotalEl.textContent = `Showing: ${dealerCard.rank === 'A' ? 'A' : dealerValue}`;

                actionButtons.forEach(b => b.disabled = false);
                handStartTime = Date.now();
            }, 450);
        }
        
        function updateRunningAccuracy() {
            const runningAccuracyEl = document.getElementById('running-accuracy');
            if (totalAttempts > 0) {
                const accuracy = ((correctFirstTry / totalAttempts) * 100).toFixed(1);
                runningAccuracyEl.textContent = `Accuracy: ${accuracy}%`;
            } else {
                runningAccuracyEl.textContent = 'Accuracy: -';
            }
        }

        function checkAnswer(userAction) {
            const feedbackEl = document.getElementById('feedback');
            const actionButtons = [...mainContent.querySelectorAll('.action-btn')];

            if (userAction === correctAnswer) {
                feedbackEl.textContent = 'Correct!';
                feedbackEl.className = 'text-center text-lg font-semibold p-4 rounded-lg h-16 mb-4 correct';
                actionButtons.forEach(b => b.disabled = true);
                if (isFirstGuess) {
                    correctFirstTry++;
                    const timeTaken = (Date.now() - handStartTime) / 1000;
                    decisionTimes.push(timeTaken);
                }
                totalAttempts++;
                updateRunningAccuracy();
                setTimeout(newHand, 500);
            } else {
                feedbackEl.textContent = 'Incorrect. Try again.';
                feedbackEl.className = 'text-center text-lg font-semibold p-4 rounded-lg h-16 mb-4 incorrect';
                if (isFirstGuess) {
                    totalAttempts++;
                    const mistake = { playerHand, dealerCard, correctAnswer, playerTotal: getHandTotal(playerHand), isSoft: isSoft(playerHand) };
                    wrongGuesses.push(mistake);
                    saveMistake(mistake);
                    updateRunningAccuracy();
                }
                isFirstGuess = false;
            }
        }
        
        function showAccuracyReport() {
            mainContent.classList.add('hidden');
            reportSection.innerHTML = `
                <div id="report-content" class="p-4 bg-gray-800 rounded-lg">
                    <h2 class="text-3xl font-bold text-center mb-2 text-white">H3KZs Quiz Report</h2>
                    <p id="accuracy-text" class="text-center text-xl font-semibold mb-2 text-indigo-400"></p>
                    <p id="time-rating" class="text-center text-lg mb-6"></p>
                    <div id="improvement-area">
                        <h3 class="text-2xl font-semibold mb-4 text-center">Hands to Improve On:</h3>
                        <ul id="wrong-guesses-list" class="list-disc list-inside mx-auto max-w-md space-y-4"></ul>
                        <p id="no-mistakes-text" class="text-center text-gray-400 hidden">You made no mistakes. Great job!</p>
                    </div>
                </div>
                <div class="text-center mt-8 space-x-4">
                    <button id="main-menu-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg shadow-md">Main Menu</button>
                    <button id="play-again-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md">Play Again</button>
                    <button id="share-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md">Share Report</button>
                </div>
            `;
            reportSection.classList.remove('hidden');

            const accuracy = totalAttempts > 0 ? ((correctFirstTry / totalAttempts) * 100).toFixed(1) : 100;
            document.getElementById('accuracy-text').textContent = `Accuracy: ${accuracy}%`;
            
            const avgTime = decisionTimes.length > 0 ? decisionTimes.reduce((a, b) => a + b, 0) / decisionTimes.length : 0;
            let timeRatingText, timeRatingColor;
            if (avgTime < 2.5) { timeRatingText = `Avg. Decision Time: ${avgTime.toFixed(2)}s (Very Fast)`; timeRatingColor = 'text-green-400';
            } else if (avgTime < 5) { timeRatingText = `Avg. Decision Time: ${avgTime.toFixed(2)}s (Fast)`; timeRatingColor = 'text-blue-400';
            } else { timeRatingText = `Avg. Decision Time: ${avgTime.toFixed(2)}s (Average)`; timeRatingColor = 'text-yellow-400';
            }
            const timeRatingEl = document.getElementById('time-rating');
            timeRatingEl.textContent = timeRatingText;
            timeRatingEl.className = `text-center text-lg mb-6 ${timeRatingColor}`;

            const wrongGuessesListEl = document.getElementById('wrong-guesses-list');
            const noMistakesTextEl = document.getElementById('no-mistakes-text');
            if (wrongGuesses.length > 0) {
                noMistakesTextEl.classList.add('hidden');
                const uniqueWrongGuesses = [...new Map(wrongGuesses.map(item => [JSON.stringify(item.playerHand) + JSON.stringify(item.dealerCard), item])).values()];
                uniqueWrongGuesses.forEach(guess => {
                    const li = document.createElement('li');
                    const handText = guess.playerHand.map(card => `${card.rank}${card.suit}`).join(', ');
                    const dealerText = `${guess.dealerCard.rank}${guess.dealerCard.suit}`;
                    const pTotal = guess.isSoft ? `Soft ${guess.playerTotal}` : `Hard ${guess.playerTotal}`;
                    const explanation = getStrategyExplanation(guess.playerHand, guess.dealerCard, gameSettings, guess.correctAnswer);
                    li.innerHTML = `Your <span class="font-mono">${handText}</span> (${pTotal}) vs. Dealer <span class="font-mono">${dealerText}</span> → Correct: <strong>${guess.correctAnswer}</strong><br><small class="text-gray-400">${explanation}</small>`;
                    wrongGuessesListEl.appendChild(li);
                });
            } else {
                noMistakesTextEl.classList.remove('hidden');
            }

            document.getElementById('main-menu-btn').addEventListener('click', endQuiz);
            document.getElementById('play-again-btn').addEventListener('click', startQuiz);
            document.getElementById('share-report-btn').addEventListener('click', shareReport);
        }
        
        function shareReport() {
            const reportContent = document.getElementById('report-content');
            html2canvas(reportContent, { backgroundColor: '#1f2937' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'H3KZ-blackjack-report.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        function loadLifetimeStats() {
            const stats = localStorage.getItem('blackjackLifetimeStats');
            if (stats) {
                lifetimeStats = JSON.parse(stats);
            }
            const storedMistakes = localStorage.getItem('blackjackMistakes');
            if(storedMistakes) {
                mistakes = JSON.parse(storedMistakes);
            }
            updateLifetimeStatsDisplay();
        }

        function saveLifetimeStats() {
            localStorage.setItem('blackjackLifetimeStats', JSON.stringify(lifetimeStats));
        }

        function updateLifetimeStats() {
            lifetimeStats.totalHandsPlayed += totalAttempts;
            lifetimeStats.totalCorrectFirstTries += correctFirstTry;
            saveLifetimeStats();
            updateLifetimeStatsDisplay();
        }
        
        function updateLifetimeStatsDisplay() {
            const { totalHandsPlayed, totalCorrectFirstTries } = lifetimeStats;
            const accuracy = totalHandsPlayed > 0 ? ((totalCorrectFirstTries / totalHandsPlayed) * 100).toFixed(1) : 'N/A';
            lifetimeStatsDisplay.textContent = `Total Hands: ${totalHandsPlayed} | Lifetime Accuracy: ${accuracy}% | Mistakes to practice: ${mistakes.length}`;
        }

        function resetLifetimeStats() {
            if (confirm("Are you sure you want to reset your lifetime stats? This cannot be undone.")) {
                lifetimeStats = { totalHandsPlayed: 0, totalCorrectFirstTries: 0 };
                mistakes = [];
                localStorage.removeItem('blackjackLifetimeStats');
                localStorage.removeItem('blackjackMistakes');
                updateLifetimeStatsDisplay();
            }
        }

        function saveMistake(mistake) {
            const mistakeKey = JSON.stringify(mistake.playerHand.sort((a,b) => a.rank.localeCompare(b.rank))) + JSON.stringify(mistake.dealerCard);
            if (!mistakes.some(m => JSON.stringify(m.playerHand.sort((a,b) => a.rank.localeCompare(b.rank))) + JSON.stringify(m.dealerCard) === mistakeKey)) {
                mistakes.push(mistake);
                localStorage.setItem('blackjackMistakes', JSON.stringify(mistakes));
            }
        }

        function renderStrategyChart() {
            const deckText = gameSettings.decks > 2 ? '6+' : gameSettings.decks;
            strategyChartTitle.textContent = `Basic Strategy Chart (${gameSettings.dealerRule.toUpperCase()}, ${deckText} Deck${gameSettings.decks > 1 ? 's' : ''}, ${gameSettings.das ? 'DAS' : 'No DAS'})`;
            
            const dealerRanks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'A'];
            let html = '<div class="flex flex-col md:flex-row md:space-x-8">';

            // Hard Totals
            html += '<div class="flex-1 mb-8 md:mb-0"><h3 class="text-xl font-semibold mb-3 text-center text-gray-800 dark:text-gray-200">Hard Totals</h3><table class="w-full strategy-table"><thead><tr><th>Hand</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>A</th></tr></thead><tbody>';
            for (let i = 17; i >= 5; i--) {
                const handLabel = i >= 17 ? '17-20' : (i <=8 ? '5-8' : i);
                if (i < 17 && i > 8 && i !== 12 && i !== 11 && i !== 10 && i !== 9) continue;
                if (i === 18 || i === 19 || i === 20) continue;
                 html += `<tr><td>${handLabel}</td>`;
                 dealerRanks.forEach(dRank => {
                    const pHand = (i === 11) ? [{rank:'5'}, {rank:'6'}] : [{rank:'10'}, {rank:(i-10).toString()}];
                    const dCard = {rank: dRank};
                    const action = getCorrectAction(pHand, dCard, gameSettings);
                    html += `<td class="cell-${action}">${action.charAt(0)}</td>`;
                 });
                 html += '</tr>';
                 if (i === 17 || i === 9) i = (i === 17) ? 13 : 5;
            }
            html += '</tbody></table></div>';
            
            // Soft and Pair Totals
            html += '<div class="flex-1">';
            html += '<h3 class="text-xl font-semibold mb-3 text-center text-gray-800 dark:text-gray-200">Soft Totals</h3><table class="w-full strategy-table mb-8"><thead><tr><th>Hand</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>A</th></tr></thead><tbody>';
            for (let i = 9; i >= 2; i--) {
                const handLabel = i >= 8 ? 'A,8-9' : `A,${i}`;
                if (i === 8) continue;
                html += `<tr><td>${handLabel}</td>`;
                dealerRanks.forEach(dRank => {
                    const pHand = [{rank:'A'}, {rank:i.toString()}];
                    const dCard = {rank: dRank};
                    const action = getCorrectAction(pHand, dCard, gameSettings);
                    html += `<td class="cell-${action}">${action.charAt(0)}</td>`;
                });
                html += '</tr>';
                if (i === 8) i = 2;
            }
            html += '</tbody></table>';
            html += '<h3 class="text-xl font-semibold mb-3 text-center text-gray-800 dark:text-gray-200">Pairs</h3><table class="w-full strategy-table"><thead><tr><th>Hand</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>A</th></tr></thead><tbody>';
            ['A','10','9','8','7','6','5','4','3','2'].forEach(pRank => {
                 html += `<tr><td>${pRank},${pRank}</td>`;
                 dealerRanks.forEach(dRank => {
                    const pHand = [{rank:pRank}, {rank:pRank}];
                    const dCard = {rank: dRank};
                    const action = getCorrectAction(pHand, dCard, gameSettings);
                    html += `<td class="cell-${action}">${action === 'Split' ? 'Y' : action.charAt(0)}</td>`;
                 });
                 html += '</tr>';
            });
            html += '</tbody></table></div></div>';
            strategyChartContainer.innerHTML = html;
        }

        function startQuiz() {
            const trainOn = {
                all: trainAllCheckbox.checked,
                hard: document.getElementById('train-hard').checked,
                soft: document.getElementById('train-soft').checked,
                pairs: document.getElementById('train-pairs').checked,
                surrender: document.getElementById('train-surrender').checked,
                challenge: document.getElementById('train-challenge').checked
            };

            if (!trainOn.all && !trainOn.hard && !trainOn.soft && !trainOn.pairs && !trainOn.surrender && !trainOn.challenge) {
                handTypeError.textContent = "Please select at least one hand type to train.";
                handTypeError.classList.remove('hidden');
                return;
            }

            if (trainOn.challenge && mistakes.length === 0) {
                handTypeError.textContent = "You have no mistakes to practice! Play some regular hands first.";
                handTypeError.classList.remove('hidden');
                return;
            }
            handTypeError.classList.add('hidden');

            gameSettings = {
                dealerRule: dealerRuleSelect.value,
                das: dasSelect.value === 'yes',
                decks: parseInt(decksSelect.value),
                trainOn: trainOn
            };

            totalHands = parseInt(handCountInput.value) || 20;
            currentHand = 0;
            correctFirstTry = 0;
            totalAttempts = 0;
            wrongGuesses = [];
            decisionTimes = [];

            setupSection.classList.add('hidden');
            reportSection.classList.add('hidden');
            
            mainContent.innerHTML = `
                <div id="quiz-section">
                    <div class="flex justify-between items-center mb-4">
                        <div id="hand-counter" class="text-left font-bold text-xl text-gray-300"></div>
                        <div class="flex items-center">
                            <div id="running-accuracy" class="text-right font-bold text-xl text-gray-300 mr-4"></div>
                            <button id="guide-toggle-btn" class="hidden p-1 rounded-full hover:bg-gray-700">
                                <svg id="eye-open-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eye-closed-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.666 1.32-3.207 2.278-4.5M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c1.206 0 2.37.247 3.44.68M21 21L3 3" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-1">
                            <div class="mb-6">
                                <h2 class="text-2xl font-semibold mb-3 text-center">Dealer's Upcard</h2>
                                <div class="flex justify-center"><div id="dealer-card" class="card hidden-initial"></div></div>
                                <p id="dealer-total" class="text-center text-xl font-bold mt-3"></p>
                            </div>
                            <div class="mb-6">
                                <h2 class="text-2xl font-semibold mb-3 text-center">Your Hand</h2>
                                <div class="flex justify-center space-x-4">
                                    <div id="player-card-1" class="card hidden-initial"></div>
                                    <div id="player-card-2" class="card hidden-initial"></div>
                                </div>
                                <p id="player-total" class="text-center text-xl font-bold mt-3"></p>
                            </div>
                        </div>
                        <div id="in-game-guide" class="flex-1 hidden"></div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-4 mb-6">
                        <button id="btn-hit" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg">Hit<span class="key-hint">1</span></button>
                        <button id="btn-stand" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg">Stand<span class="key-hint">2</span></button>
                        <button id="btn-double" class="action-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg">Double<span class="key-hint">3</span></button>
                        <button id="btn-split" class="action-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg">Split<span class="key-hint">4</span></button>
                        <button id="btn-surrender" class="action-btn bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg">Surrender<span class="key-hint">5</span></button>
                    </div>
                    <div id="feedback" class="text-center text-lg font-semibold p-4 rounded-lg h-16 mb-4"></div>
                </div>
            `;
            mainContent.classList.remove('hidden');
            
            const actionButtons = [...mainContent.querySelectorAll('.action-btn')];
            actionButtons.forEach(btn => btn.addEventListener('click', () => checkAnswer(btn.textContent.replace(/\d/, '').trim())));
            
            if (!gameSettings.trainOn.all) {
                renderInGameGuide();
                const guideToggleBtn = document.getElementById('guide-toggle-btn');
                guideToggleBtn.classList.remove('hidden');
                guideToggleBtn.addEventListener('click', toggleInGameGuide);
            }

            renderStrategyChart();
            updateRunningAccuracy();
            newHand();
        }

        function renderInGameGuide() {
            const guideContainer = document.getElementById('in-game-guide');
            const { trainOn } = gameSettings;
            let guideHtml = '';
            const chartSections = strategyChartContainer.querySelectorAll('.flex-1');

            if (chartSections.length < 2) return; 

            if (trainOn.hard || trainOn.surrender) {
                guideHtml += chartSections[0].innerHTML;
            } else if (trainOn.soft) {
                const softSection = chartSections[1];
                const heading = softSection.querySelector('h3');
                const table = softSection.querySelector('table');
                if (heading && table) {
                    guideHtml += heading.outerHTML + table.outerHTML;
                }
            } else if (trainOn.pairs) {
                const softSection = chartSections[1];
                const heading = softSection.querySelectorAll('h3')[1];
                const table = softSection.querySelectorAll('table')[1];
                if (heading && table) {
                    guideHtml += heading.outerHTML + table.outerHTML;
                }
            }
            guideContainer.innerHTML = guideHtml;
            guideContainer.classList.remove('hidden');
        }

        function toggleInGameGuide() {
            const guideContainer = document.getElementById('in-game-guide');
            const eyeOpen = document.getElementById('eye-open-icon');
            const eyeClosed = document.getElementById('eye-closed-icon');
            guideContainer.classList.toggle('hidden');
            eyeOpen.classList.toggle('hidden');
            eyeClosed.classList.toggle('hidden');
        }
        
        function endQuiz() {
            mainContent.classList.add('hidden');
            reportSection.classList.add('hidden');
            setupSection.classList.remove('hidden');
        }
        
        function handleKeyPress(e) {
            if (mainContent.classList.contains('hidden')) return; // Only active during quiz

            let btn;
            switch (e.key) {
                case '1': btn = document.getElementById('btn-hit'); break;
                case '2': btn = document.getElementById('btn-stand'); break;
                case '3': btn = document.getElementById('btn-double'); break;
                case '4': btn = document.getElementById('btn-split'); break;
                case '5': btn = document.getElementById('btn-surrender'); break;
                default: return;
            }

            if (btn && !btn.disabled) {
                btn.click();
                btn.classList.add('key-pressed');
                setTimeout(() => btn.classList.remove('key-pressed'), 200);
            }
        }

        // --- Initial Load & Event Listeners ---
        startQuizBtn.addEventListener('click', startQuiz);
        resetStatsBtn.addEventListener('click', resetLifetimeStats);
        window.addEventListener('keydown', handleKeyPress);
        [dealerRuleSelect, dasSelect, decksSelect].forEach(el => el.addEventListener('change', () => {
             gameSettings = {
                dealerRule: dealerRuleSelect.value,
                das: dasSelect.value === 'yes',
                decks: parseInt(decksSelect.value)
            };
            renderStrategyChart();
        }));

        trainAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            handTypeCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = isChecked;
            });
        });

        handTypeCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                let anyChecked = [...handTypeCheckboxes].some(c => c.checked);
                trainAllCheckbox.checked = !anyChecked;
                trainAllCheckbox.disabled = anyChecked;
            });
        });

        window.addEventListener('load', () => {
            loadLifetimeStats();
            gameSettings = { dealerRule: 's17', das: true, decks: 6 }; // Default for initial chart
            renderStrategyChart();
        });
    </script>
</body>
</html>
